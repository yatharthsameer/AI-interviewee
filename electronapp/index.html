<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <!-- GitHub Markdown CSS for beautiful styling -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">
  <style>
    html,
    body {
      margin: 0;
      height: 100%;
      background: rgba(30, 30, 30, .85);
      overflow: hidden;
      font-family: monospace;
    }

    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-height: 100vh;
      overflow: hidden;
    }

    /* Pages */
    .page {
      flex: 1;
      display: none;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .page.active {
      display: flex;
    }

    /* Notes page - Updated for markdown rendering */
    #solution {
      flex: 1;
      width: 100%;
      border: none;
      outline: none;
      background: rgba(40, 40, 40, .9);
      color: #fff;
      padding: 12px;
      display: block;
      border-top: 1px solid #555;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.4;
    }

    /* Markdown styling overrides for dark theme */
    #solution.markdown-body {
      background: rgba(40, 40, 40, .9) !important;
      color: #fff !important;
      font-size: 13px !important;
      line-height: 1.4 !important;
    }

    #solution.markdown-body h1,
    #solution.markdown-body h2,
    #solution.markdown-body h3,
    #solution.markdown-body h4,
    #solution.markdown-body h5,
    #solution.markdown-body h6 {
      color: #fff !important;
      border-bottom-color: #555 !important;
    }

    #solution.markdown-body pre {
      background: rgba(20, 20, 20, .8) !important;
      border: 1px solid #555 !important;
    }

    #solution.markdown-body code {
      background: rgba(20, 20, 20, .6) !important;
      color: #f8f8f2 !important;
      border: 1px solid #444 !important;
    }

    #solution.markdown-body blockquote {
      color: #ccc !important;
      border-left-color: #666 !important;
    }

    #solution.markdown-body table tr {
      background: rgba(50, 50, 50, .5) !important;
      border-top-color: #555 !important;
    }

    #solution.markdown-body table tr:nth-child(2n) {
      background: rgba(60, 60, 60, .5) !important;
    }

    #solution.markdown-body table th,
    #solution.markdown-body table td {
      border-color: #555 !important;
    }

    #solution.markdown-body a {
      color: #79b8ff !important;
    }

    #solution.markdown-body strong {
      color: #fff !important;
    }

    /* Empty state styling */
    #solution.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
      font-style: italic;
    }

    /* Chat page */
    #chatContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      min-height: 0;
      overflow: hidden;
      height: 0; /* Force flex child to respect parent constraints */
    }

    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      height: 0; /* Force flex child to respect parent constraints */
    }

    #chatInputContainer {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px 0;
      border-top: 1px solid #555;
      flex-shrink: 0;
    }

    /* Image preview in chat */
    #imagePreviewContainer {
      position: relative;
      align-self: flex-start;
      max-width: 200px;
    }
    
    #imagePreview {
      width: 100%;
      max-width: 200px;
      height: auto;
      border-radius: 8px;
      border: 1px solid #666;
    }
    
    #removeImageBtn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: rgba(180, 70, 70, .9);
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font: 12px monospace;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #inputRow {
      display: flex;
      gap: 8px;
    }

    #chatInput {
      flex: 1;
      padding: 8px;
      background: rgba(60, 60, 60, .8);
      color: #eee;
      border: 1px solid #666;
      border-radius: 4px;
      font: 13px monospace;
      outline: none;
    }

    #sendBtn {
      padding: 8px 12px;
      background: rgba(70, 130, 180, .8);
      color: #fff;
      border: 1px solid #5a9fd4;
      border-radius: 4px;
      cursor: pointer;
      font: 12px monospace;
      min-width: 60px;
    }

    #sendBtn:hover {
      background: rgba(90, 150, 200, .9);
    }

    #sendBtn:disabled {
      background: rgba(50, 50, 50, .5);
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Chat bubbles - Updated for markdown */
    .message {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 12px;
      margin: 2px 0;
      word-wrap: break-word;
      font: 13px/1.4 monospace;
    }

    .message.user {
      background: rgba(70, 130, 180, .8);
      color: #fff;
      align-self: flex-end;
    }

    .message.ai {
      background: rgba(60, 60, 60, .8);
      color: #eee;
      align-self: flex-start;
    }

    .message.error {
      background: rgba(180, 70, 70, .8);
      color: #fff;
      align-self: flex-start;
    }

    /* Markdown styling for chat messages */
    .message.markdown-body {
      font-size: 13px !important;
      line-height: 1.4 !important;
    }

    .message.ai.markdown-body {
      background: rgba(60, 60, 60, .8) !important;
      color: #eee !important;
    }

    .message.ai.markdown-body h1,
    .message.ai.markdown-body h2,
    .message.ai.markdown-body h3,
    .message.ai.markdown-body h4,
    .message.ai.markdown-body h5,
    .message.ai.markdown-body h6 {
      color: #fff !important;
      border-bottom-color: #555 !important;
      margin: 8px 0 4px 0 !important;
    }

    .message.ai.markdown-body pre {
      background: rgba(20, 20, 20, .8) !important;
      border: 1px solid #444 !important;
      margin: 8px 0 !important;
    }

    .message.ai.markdown-body code {
      background: rgba(20, 20, 20, .6) !important;
      color: #f8f8f2 !important;
      border: 1px solid #333 !important;
    }

    .message.ai.markdown-body blockquote {
      color: #ccc !important;
      border-left-color: #666 !important;
      margin: 8px 0 !important;
    }

    .message.ai.markdown-body a {
      color: #79b8ff !important;
    }

    .message.ai.markdown-body strong {
      color: #fff !important;
    }

    .message.ai.markdown-body ul,
    .message.ai.markdown-body ol {
      margin: 8px 0 !important;
      padding-left: 20px !important;
    }

    .message.ai.markdown-body p {
      margin: 8px 0 !important;
    }

    /* Common elements */
    #status {
      position: absolute;
      top: 5px;
      right: 10px;
      color: #888;
      font: 10px monospace;
      z-index: 100;
    }

    #buttonContainer {
      display: flex;
      padding: 8px;
      gap: 8px;
      border-top: 1px solid #555;
      background: rgba(20, 20, 20, .9);
    }

    .btn {
      flex: 1;
      padding: 8px 12px;
      background: rgba(60, 60, 60, .8);
      color: #eee;
      border: 1px solid #666;
      border-radius: 4px;
      cursor: pointer;
      font: 12px monospace;
      text-align: center;
      transition: all 0.2s;
    }

    .btn:hover {
      background: rgba(80, 80, 80, .9);
      border-color: #888;
    }

    .btn:active {
      background: rgba(100, 100, 100, .9);
    }

    .btn.active {
      background: rgba(70, 130, 180, .8);
      border-color: #5a9fd4;
    }

    .btn.clear {
      background: rgba(80, 50, 50, .8);
      border-color: #a66;
    }

    .btn.clear:hover {
      background: rgba(100, 60, 60, .9);
    }

    .error {
      color: #f44 !important;
    }

    .loading {
      color: #fa0 !important;
    }
    
    /* Screenshot Preview Area */
    #screenshotPreviewArea { 
      display:none; 
      padding:8px; 
      background:rgba(50,50,50,.9); 
      border-top:1px solid #555; 
      flex-shrink:0; 
      max-height:120px; 
      overflow-y:auto; 
    }
    #screenshotPreviewContainer { 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      align-items:center; 
    }
    .screenshot-preview { 
      position:relative; 
      display:inline-block; 
    }
    .screenshot-preview img { 
      width:80px; 
      height:60px; 
      object-fit:cover; 
      border-radius:4px; 
      border:1px solid #666; 
    }
    .screenshot-remove { 
      position:absolute; 
      top:-4px; 
      right:-4px; 
      width:16px; 
      height:16px; 
      background:rgba(180,70,70,.9); 
      color:#fff; 
      border:none; 
      border-radius:50%; 
      cursor:pointer; 
      font:10px monospace; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
    }
    #screenshotCount { 
      color:#888; 
      font:12px monospace; 
      margin-left:8px; 
    }
    #processHint { 
      color:#888; 
      font:11px monospace; 
      margin-left:auto; 
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="status">Interview Helper</div>

    <!-- Notes Page -->
    <div id="notesPage" class="page active">
      <!-- Solution display area - Changed from textarea to div for markdown -->
      <div id="solution" class="markdown-body empty">Screenshot solution will appear here...</div>
      <!-- Screenshot Preview Area -->
      <div id="screenshotPreviewArea">
        <div id="screenshotPreviewContainer">
          <span id="screenshotCount">0 screenshots</span>
          <span id="processHint">Press Cmd+Enter to process</span>
        </div>
      </div>
    </div>

    <!-- Chat Page -->
    <div id="chatPage" class="page">
      <div id="chatContainer">
        <div id="chatMessages"></div>
        <div id="chatInputContainer">
          <!-- Image preview area above input -->
          <div id="imagePreviewContainer" style="display: none;">
            <img id="imagePreview" />
            <button id="removeImageBtn">×</button>
          </div>
          <div id="inputRow">
            <input type="text" id="chatInput" placeholder="Ask a question..." />
            <button id="sendBtn">Send</button>
            </div>
            </div>
            </div>
    </div>

    <!-- Button container -->
    <div id="buttonContainer">
      <button class="btn clear" id="clearBtn">Interview Helper</button>
      <button class="btn" id="chatBtn">Chat</button>
      <button class="btn" id="dummyBtn2">Clear Page</button>
    </div>
  </div>

  <!-- Include marked library for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Check if marked library is loaded
        document.addEventListener('DOMContentLoaded', function () {
          if (typeof marked === 'undefined') {
            console.error('Marked library not loaded! Using fallback rendering.');
          } else {
            console.log('Marked library loaded successfully');
          }
        });

        // Markdown rendering functions
        function renderMarkdown(text) {
          try {
            if (typeof marked !== 'undefined') {
              return marked.parse(text);
            } else {
              console.warn('Marked library not available, using fallback');
              return formatTextFallback(text);
            }
          } catch (error) {
            console.error('Error parsing markdown:', error);
            return formatTextFallback(text);
          }
        }

        // Fallback text formatting for basic markdown-like rendering
        function formatTextFallback(text) {
          return text
            // Convert code blocks
            .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
            // Convert inline code
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            // Convert bold text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Convert headers
            .replace(/^### (.*$)/gm, '<h3>$1</h3>')
            .replace(/^## (.*$)/gm, '<h2>$1</h2>')
            .replace(/^# (.*$)/gm, '<h1>$1</h1>')
            // Convert line breaks
            .replace(/\n/g, '<br>');
        }

        function setSolutionContent(content) {
          const solutionEl = document.getElementById('solution');
          if (!content || content.trim() === '') {
            solutionEl.innerHTML = 'Screenshot solution will appear here...';
            solutionEl.classList.add('empty');
            solutionEl.classList.remove('markdown-body');
          } else {
            const renderedContent = renderMarkdown(content);
            solutionEl.innerHTML = renderedContent;
            solutionEl.classList.remove('empty');
            solutionEl.classList.add('markdown-body');
          }
        }

                // Screenshot accumulation for LeetCode Helper
                let accumulatedScreenshots = [];

                function addScreenshotToPreview(imageData) {
                  console.log('addScreenshotToPreview called with data length:', imageData.length);
                  accumulatedScreenshots.push(imageData);
                  console.log('Screenshots array now has:', accumulatedScreenshots.length, 'items');
                  updateScreenshotPreview();
                  showScreenshotPreviewArea();
                  console.log(`Added screenshot, total: ${accumulatedScreenshots.length}`);
                }

                function removeScreenshotFromPreview(index) {
                  accumulatedScreenshots.splice(index, 1);
                  updateScreenshotPreview();
                  if (accumulatedScreenshots.length === 0) {
                    hideScreenshotPreviewArea();
                  }
                  console.log(`Removed screenshot, total: ${accumulatedScreenshots.length}`);
                }

                function updateScreenshotPreview() {
                  const container = document.getElementById('screenshotPreviewContainer');
                  const countEl = document.getElementById('screenshotCount');

                // Clear existing previews except count and hint
                const previews = container.querySelectorAll('.screenshot-preview');
                previews.forEach(preview => preview.remove());

                // Add new previews
                accumulatedScreenshots.forEach((imageData, index) => {
                  const previewDiv = document.createElement('div');
                  previewDiv.className = 'screenshot-preview';

                const img = document.createElement('img');
                img.src = `data:image/png;base64,${imageData}`;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'screenshot-remove';
                removeBtn.textContent = '×';
                removeBtn.addEventListener('click', () => removeScreenshotFromPreview(index));

                previewDiv.appendChild(img);
                previewDiv.appendChild(removeBtn);

                // Insert before the count element
                container.insertBefore(previewDiv, countEl);
              });

                // Update count
                countEl.textContent = `${accumulatedScreenshots.length} screenshot${accumulatedScreenshots.length !== 1 ? 's' : ''}`;
              }

                function showScreenshotPreviewArea() {
                  document.getElementById('screenshotPreviewArea').style.display = 'block';
                }

                function hideScreenshotPreviewArea() {
                  document.getElementById('screenshotPreviewArea').style.display = 'none';
                }

                function clearAccumulatedScreenshots() {
                  accumulatedScreenshots = [];
                  hideScreenshotPreviewArea();
                  console.log('Cleared all accumulated screenshots');
                }

                async function processAccumulatedScreenshots() {
                  if (accumulatedScreenshots.length === 0) {
                    console.log('No screenshots to process');
                    return;
                  }

                console.log(`Processing ${accumulatedScreenshots.length} accumulated screenshots`);
                hideScreenshotPreviewArea();

                try {
                  if (window.electronAPI) {
                    await window.electronAPI.processAccumulatedScreenshots([...accumulatedScreenshots]);
                    clearAccumulatedScreenshots();
                  }
                } catch (error) {
                  console.error('Error processing screenshots:', error);
                  showScreenshotPreviewArea(); // Show preview area again on error
                }
              }

    // Page management
    const notesPage = document.getElementById('notesPage');
    const chatPage = document.getElementById('chatPage');
    const chatBtn = document.getElementById('chatBtn');
    const clearBtn = document.getElementById('clearBtn');

    let currentPage = 'notes';

    function showPage(pageName) {
      if (pageName === 'chat') {
        notesPage.classList.remove('active');
        chatPage.classList.add('active');
        chatBtn.classList.add('active');
        clearBtn.classList.remove('active');
        currentPage = 'chat';
        document.getElementById('status').textContent = 'Chat Mode';
      } else {
        chatPage.classList.remove('active');
        notesPage.classList.add('active');
        chatBtn.classList.remove('active');
        clearBtn.classList.remove('active');
        currentPage = 'notes';
        document.getElementById('status').textContent = 'Interview Helper';
      }
    }

                // Chat functionality with markdown support
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                const imagePreview = document.getElementById('imagePreview');
                const removeImageBtn = document.getElementById('removeImageBtn');

                let currentImageData = null;

                function addMessage(text, type = 'user', imageData = null) {
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;

                if (imageData && type === 'user') {
                  // Add image to user message
                  const img = document.createElement('img');
                  img.src = `data:image/png;base64,${imageData}`;
                  img.style.maxWidth = '200px';
                  img.style.borderRadius = '8px';
                  img.style.marginBottom = '8px';
                  img.style.display = 'block';
                  messageEl.appendChild(img);
                }

                if (text) {
                if (type === 'ai') {
                  // Render AI messages as markdown
                  const renderedContent = renderMarkdown(text);
                  messageEl.innerHTML = (imageData && type === 'user' ? messageEl.innerHTML : '') + renderedContent;
                  messageEl.classList.add('markdown-body');
                } else {
                // User messages remain as plain text
                const textNode = document.createTextNode(text);
                messageEl.appendChild(textNode);
              }
              }

      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

                function showImagePreview(imageData) {
                  currentImageData = imageData;
                  imagePreview.src = `data:image/png;base64,${imageData}`;
                  imagePreviewContainer.style.display = 'block';
                  chatInput.placeholder = 'Ask about this image...';
                }

                function hideImagePreview() {
                  currentImageData = null;
                  imagePreview.src = '';
                  imagePreviewContainer.style.display = 'none';
                  chatInput.placeholder = 'Ask a question...';
                }

    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text && !currentImageData) return;

      // Add user message with image if present
      addMessage(text, 'user', currentImageData);

      // Prepare data for sending
      const messageText = text || null;
      const imageData = currentImageData;

      // Clear input and image
      chatInput.value = '';
      hideImagePreview();
      
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      // Send to backend
      if (window.electronAPI) {
        window.electronAPI.sendChatMessage(messageText, imageData);
      }
    }

    // Button event listeners
    chatBtn.addEventListener('click', () => showPage('chat'));
    clearBtn.addEventListener('click', () => {
      // Always go to Interview Helper page
      showPage('notes');
    });

      // Dynamic clear button (Button 3) - clears based on current page
      document.getElementById('dummyBtn2').addEventListener('click', () => {
        if (currentPage === 'chat') {
          // Clear chat messages
          chatMessages.innerHTML = '';
          console.log('Chat history cleared');
        } else {
          // Clear solution and accumulated screenshots
          setSolutionContent('');
          clearAccumulatedScreenshots();
          console.log('Interview Helper page cleared');
      }
    });

    // Chat input handlers
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

                removeImageBtn.addEventListener('click', hideImagePreview);

                // Handle screenshot for chat mode
                function onChatScreenshotCaptured(imageData) {
                  console.log('Chat screenshot captured, showing preview');
                  showImagePreview(imageData);
                }

    // Handle electron API
    if (window.electronAPI) {
      const statusEl = document.getElementById('status');

      // Chat response handlers
      window.electronAPI.onChatResponse((response) => {
        addMessage(response, 'ai');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      });

      window.electronAPI.onChatError((error) => {
        addMessage(`Error: ${error}`, 'error');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      });

      // Screenshot handlers with markdown rendering
      window.electronAPI.onScreenshotSolution((solution) => {
        console.log('Received solution:', solution);
        console.log('Solution length:', solution.length);
        
        // Set the solution with markdown rendering
        setSolutionContent(solution);
        console.log('Solution set with markdown rendering');

        // Auto-clear after 60 seconds
        setTimeout(() => {
          setSolutionContent('');
          console.log('Auto-cleared solution after 60 seconds');
        }, 60000);
      });

      window.electronAPI.onScreenshotError((error) => {
        console.error('Screenshot error:', error);
        statusEl.textContent = 'Error: ' + error;
        statusEl.className = 'error';

        setTimeout(() => {
          statusEl.textContent = currentPage === 'chat' ? 'Chat Mode' : 'Interview Helper';
          statusEl.className = '';
        }, 5000);
      });

      // LeetCode Helper screenshot accumulation
      window.electronAPI.onLeetcodeScreenshotCaptured((imageData) => {
        console.log('Received screenshot for LeetCode Helper, currentPage:', currentPage);
        console.log('Image data length:', imageData.length);
        if (currentPage === 'notes') {
          console.log('Adding screenshot to preview...');
          addScreenshotToPreview(imageData);
        } else {
          console.log('Not in notes page, ignoring screenshot');
        }
      });

      // Mode detection for screenshot shortcut
      function onCheckCurrentMode() {
        console.log('Current mode check, current page:', currentPage);
        if (currentPage === 'chat') {
          // In chat mode - take screenshot and add to chat input
          window.electronAPI.takeScreenshotForMode('chat');
        } else if (currentPage === 'notes') {
          // In interview mode - take screenshot and add to accumulation
          window.electronAPI.takeScreenshotForMode('interview');
        }
      }

      // Loading state for screenshots
      document.addEventListener('keydown', (e) => {
        if (e.metaKey && e.shiftKey && e.key === '1') {
          if (currentPage !== 'notes') showPage('notes');
          statusEl.textContent = 'Processing...';
          statusEl.className = 'loading';
        }
      });

      // Cmd+Enter to process accumulated screenshots
      document.addEventListener('keydown', (e) => {
        if (e.metaKey && e.key === 'Enter') {
          console.log('Cmd+Enter pressed, currentPage:', currentPage, 'screenshots:', accumulatedScreenshots.length);
          if (currentPage === 'notes' && accumulatedScreenshots.length > 0) {
            console.log('Processing accumulated screenshots...');
            e.preventDefault();
            processAccumulatedScreenshots();
          } else {
            console.log('Not processing - either wrong page or no screenshots');
          }
        }
      });

      // Handle screenshot captured for chat mode
      window.electronAPI.onChatScreenshotCaptured(onChatScreenshotCaptured);

      // Register mode check handler
      window.electronAPI.onCheckCurrentMode(onCheckCurrentMode);
    }
  </script>
</body>

</html>